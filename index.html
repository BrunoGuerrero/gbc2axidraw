<html>
	<body>
		<input id="image-input" type="file"><br>
		Resulting SVG:<br>
		<svg id="svg" height="112" width="125" xmlns="http://www.w3.org/2000/svg"></svg><br>
		<a id="dlSVG" href="#">Download</a><br>
		<div style="display:none">
			Source image:<br>
			<img id="sourceImage" src=""><br>
			<canvas id="canvas" height="112" width="125"><br>
		</div>

		<form style="display:none">
			<input type="radio" name="style" value="square" checked style="display:none"><label>Squares</label><br>
			<input type="radio" name="style" value="circle" style="display:none"><label>Circle</label><br>
		</form>
	</body>

	<script>
		(function () {
			const canvasElement = document.getElementById("canvas")
			const ctx = canvasElement.getContext("2d")

			loadedImage = null;

			function rgbToHex(r, g, b) {
				if (r > 255 || g > 255 || b > 255)
					throw "Invalid color component";
				return ((r << 16) | (g << 8) | b).toString(16);
			}

			function dlSVG() {
				var svg = document.getElementById("svg");
				var xml = new XMLSerializer().serializeToString(svg);

				var svg64 = btoa(xml);
				var b64Start = 'data:application/octet-stream/svg+xml;base64,';
				var fullSvg = b64Start + svg64;

				this.setAttribute("download", "sheet.svg")
				this.href = fullSvg;
			}

			function changeStyle(event) {
				rects = document.getElementsByTagName("rect")	
				circs = document.getElementsByTagName("circle")	
				paths = document.getElementsByTagName("path")	

				elementsToRemove = []

				if(event.target.value == "circle") {
					for(rect of rects) {
						groupNode = rect.parentNode;

						x = parseFloat(rect.getAttribute("x"))
						y = parseFloat(rect.getAttribute("y"))

						circElement = document.createElementNS("http://www.w3.org/2000/svg", "circle")
						circElement.setAttribute("cx", x + 0.5)
						circElement.setAttribute("cy", y + 0.5)
						circElement.setAttribute("r", 0.5)
						circElement.setAttribute("fill", rect.getAttribute("fill"))

						groupNode.appendChild(circElement)
						elementsToRemove.push(rect);
					}
				}

				if(event.target.value == "square") {
					for(circ of circs) {
						groupNode = circ.parentNode;

						x = parseFloat(circ.getAttribute("cx"))
						y = parseFloat(circ.getAttribute("cy"))

						rectElement = document.createElementNS("http://www.w3.org/2000/svg", "circle")
						rectElement.setAttribute("x", x - 0.5)
						rectElement.setAttribute("y", y - 0.5)
						rectElement.setAttribute("width", 1)
						rectElement.setAttribute("height", 1)
						rectElement.setAttribute("fill", circ.getAttribute("fill"))

						groupNode.appendChild(rectElement)
						elementsToRemove.push(circ);
					}
				}

				for(elt of elementsToRemove) {
					parent = elt.parentNode;
					parent.removeChild(elt)
					delete(elt)
				}
			}

			styleInputs = document.querySelectorAll("input[name='style']");
			for(input of styleInputs) {
				input.addEventListener("change", changeStyle);
			}

			imageInput = document.getElementById("image-input");
			imageInput.addEventListener("change", ingestImage);
			sourceImageElt = document.getElementById("sourceImage");

			buttonElement = document.getElementById("dlSVG");
			buttonElement.addEventListener('click', dlSVG, false);

			function ingestImage() {
				const reader = new FileReader();

				reader.addEventListener("load", () => {
					const uploaded_image = reader.result;

					layers = {};

					sourceImageElt.src = uploaded_image;
					sourceImageElt.onload = function () {
						sourceWidth = this.width;
						sourceHeight = this.height;

						canvasElement.setAttribute('width', sourceWidth);
						canvasElement.setAttribute('height', sourceHeight);

						ctx.fillStyle = 'white';
						ctx.rect(0, 0, sourceWidth, sourceHeight);
						ctx.fill();

						ctx.drawImage(sourceImageElt, 0, 0, sourceWidth, sourceHeight, 0, 0, sourceWidth, sourceHeight);

						for (x = 0; x < sourceWidth; x++) {
							for (y = 0; y < sourceHeight; y++) {
								pixelData = ctx.getImageData(x, y, 1, 1).data;
								hexColor = "#" + ("000000" + rgbToHex(pixelData[0], pixelData[1], pixelData[2])).slice(-6);
								if (!(hexColor in layers)) {
									layers[hexColor] = []
								}
								layers[hexColor].push([x, y])
							}
						}

						svgElement = document.getElementById('svg');
						svgElement.setAttribute('width', sourceWidth)
						svgElement.setAttribute('height', sourceHeight)
						svgElement.setAttribute('xmlns', "http://www.w3.org/2000/svg")

						layerIndex = 0;
						for (layerColor in layers) {
							layer = layers[layerColor]
							gElement = document.createElementNS("http://www.w3.org/2000/svg", "g");
							gElement.setAttribute("inkscape:groupmode", "layer")
							gElement.setAttribute("inkscape:label", layerIndex)

							for (pixel of layer) {
								rectElement = document.createElementNS("http://www.w3.org/2000/svg", "rect")
								rectElement.setAttribute("x", pixel[0])
								rectElement.setAttribute("y", pixel[1])
								rectElement.setAttribute("width", 1)
								rectElement.setAttribute("height", 1)
								rectElement.setAttribute("fill", layerColor)
								rectElement.setAttribute("stroke-width", "0")
								gElement.appendChild(rectElement);
							}
							svgElement.appendChild(gElement);
							layerIndex++;
						}
					};
				});

				reader.readAsDataURL(this.files[0]);
			}
		})();
	</script>

</html>